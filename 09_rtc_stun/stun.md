
### 格式

```shell
   0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |0 0|     STUN Message Type     |         Message Length        |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                         Magic Cookie                          |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                                                               |
 |                     Transaction ID (96 bits)                  |
 |                                                               |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

```
#### Message Type

定义了消息的类型（请求/成功响应/失败响应/指示）和消息的主方法

```shell
  0                 1
 2  3  4 5 6 7 8 9 0 1 2 3 4 5
+--+--+-+-+-+-+-+-+-+-+-+-+-+-+
|M |M |M|M|M|C|M|M|M|C|M|M|M|M|
|11|10|9|8|7|1|6|5|4|0|3|2|1|0|
+--+--+-+-+-+-+-+-+-+-+-+-+-+-+
```

其中显示的位为从最高有效位M11到最低有效位M0，M11到M0表示方法的12位编码.

C1和C0两位表示类的编码。比如对于binding方法来说:

```shell
0b00表示request
0b01表示indication
0b10表示success response
0b11表示error response
```

每一个method都有可能对应不同的传输类别,拓展定义新方法的时候注意要指定该方法允许哪些类型的消息.

#### Message Length

存储了信息的长度，以字节为单位，不包括20字节的STUN头部.

由于所有的STUN属性都是都是4字节对齐（填充）的,因此这个字段最后两位应该恒等于零，这也是辨别STUN包的一个方法之一.

#### Magic Cookie

固定值0x2112A442，这是为了前向兼容RFC3489，因为在classic STUN中，这一区域是事务ID的一部分.

#### Transaction ID

是个96位的标识符,用来区分不同的STUN传输事务.

对于request/response传输，事务ID由客户端选择,服务器收到后以同样的事务ID返回response.

对于indication则由发送方自行选择. 事务ID的主要功能是request和response联系起来.

重发同样的request请求时可以重用相同的事务ID，但是客户端进行新的传输时，必须选择一个新的事务ID.

### 属性

在STUN报文头部之后，通常跟着0个或者多个属性，每个属性必须是TLV编码的(Type-Length-Value).

其中Type字段和Length字段都是16位,Value字段为为32位表示.

```shell
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |         Type                  |            Length             |
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
 |                         Value (variable)                ....
 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+

```
